echo "[ğŸ¶ Husky] Running prepare-commit-msg hook..."

commit_msg_file=$1
commit_source=$2

if [ "$commit_source" = "commit" ]; then
    echo "[ğŸ¶ Husky] Amend commit detected. Skipping prepare-commit-msg script."
    echo "[ğŸ¶ Husky] Done âœ… prepare-commit-msg hook..."
    exit 0
fi

commitlint_output=$(yarn commitlint --edit "$commit_msg_file" 2>&1)
commitlint_exit_code=$?

if [ "$commitlint_exit_code" -ne 1 ]; then

  if [ "$commit_source" = "message" ]; then
      echo "[ğŸ¶ Husky] Amend commit detected. Skipping prepare-commit-msg script."
      echo "[ğŸ¶ Husky] Done âœ… prepare-commit-msg hook..."
      exit 0
  fi

    echo "[ğŸ¶ Husky] Commitlint failed. Starting wizard commit message."
    yarn husky:prepare-commit-msg
else
    echo "[ğŸ¶ Husky] âŒ Commitlint passed. Proceeding with the commit."
    exit 1
fi

if grep -qE "SC-[0-9]+" "$commit_msg_file"; then
    issue_number=$(grep -oE "SC-[0-9]+" "$commit_msg_file" | head -n1)
    sed -i.bak -E "s/^([^:]+: )(.*)/\1[$issue_number] \2/" "$commit_msg_file"
    sed -i.bak "/^$issue_number$/d" "$commit_msg_file"
    sed -i.bak '/^$/N;/^\n$/D' "$commit_msg_file"
    rm "${commit_msg_file}.bak"
    echo "[ğŸ¶ Husky] Added issue number [$issue_number] to commit message and removed footer."
fi

echo "[ğŸ¶ Husky] Done âœ… prepare-commit-msg hook..."
